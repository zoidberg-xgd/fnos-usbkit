# USBå¤‡ä»½å·¥å…·ä½¿ç”¨æŒ‡å—

## ğŸ“¦ å·¥å…·ä»‹ç»

è¿™å¥—å·¥å…·ä¸“é—¨ä¸º**é£ç‰›OS**è®¾è®¡ï¼Œæ”¯æŒè‡ªåŠ¨è¯†åˆ«å’ŒæŒ‚è½½**å¤æ‚çš„ç§»åŠ¨ç¡¬ç›˜**ï¼ˆRAID + LVMï¼‰ï¼Œå¹¶æä¾›å®Œæ•´çš„å¤‡ä»½/æ¢å¤åŠŸèƒ½ã€‚

### âœ¨ ç‰¹æ€§

- âœ… è‡ªåŠ¨æ£€æµ‹USBå­˜å‚¨è®¾å¤‡
- âœ… æ”¯æŒRAIDé˜µåˆ—è‡ªåŠ¨ç»„è£…
- âœ… æ”¯æŒLVMé€»è¾‘å·æ¿€æ´»
- âœ… å¢é‡å¤‡ä»½ï¼ˆrsyncï¼‰
- âœ… å¤‡ä»½å†å²ç®¡ç†
- âœ… å®‰å…¨å¸è½½æœºåˆ¶
- âœ… è¯»å†™é€Ÿåº¦æµ‹è¯•
- âœ… å›¾å½¢åŒ–èœå•ç•Œé¢

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

### æ–¹æ³•ä¸€ï¼šå›¾å½¢åŒ–ç®¡ç†å™¨ï¼ˆæ¨èï¼‰

```bash
ssh root@192.168.31.104
usb-backup
```

è¿›å…¥äº¤äº’å¼èœå•ï¼ŒæŒ‰æ•°å­—é€‰æ‹©æ“ä½œï¼š
- `1` - æŒ‚è½½ç§»åŠ¨ç¡¬ç›˜
- `2` - å®‰å…¨å¸è½½
- `3` - å¼€å§‹å¤‡ä»½
- `4` - æŸ¥çœ‹å¤‡ä»½å†å²
- `5` - æ¢å¤å¤‡ä»½
- `6` - æŸ¥çœ‹USBçŠ¶æ€
- `7` - æµ‹è¯•è¯»å†™é€Ÿåº¦

### æ–¹æ³•äºŒï¼šå‘½ä»¤è¡Œç›´æ¥è°ƒç”¨

```bash
# æŒ‚è½½ç§»åŠ¨ç¡¬ç›˜
mount_usb_backup.sh

# æ‰§è¡Œå¤‡ä»½
auto_backup_to_usb.sh

# å®‰å…¨å¸è½½
umount_usb_backup.sh
```

---

## ğŸ“– è¯¦ç»†è¯´æ˜

### 1ï¸âƒ£ æŒ‚è½½ç§»åŠ¨ç¡¬ç›˜

**è„šæœ¬**: `mount_usb_backup.sh`

**åŠŸèƒ½**:
- è‡ªåŠ¨æ£€æµ‹USBè®¾å¤‡
- è¯†åˆ«RAIDæˆå‘˜å¹¶ç»„è£…RAIDé˜µåˆ—
- æ¿€æ´»LVMé€»è¾‘å·
- æŒ‚è½½åˆ° `/mnt/usb_backup`

**ç¤ºä¾‹è¾“å‡º**:
```
======================================
  ç§»åŠ¨ç¡¬ç›˜è‡ªåŠ¨æŒ‚è½½å·¥å…·
======================================

[INFO] æ­¥éª¤ 1/5: æ£€æµ‹USBè®¾å¤‡...
[SUCCESS] æ£€æµ‹åˆ°USBè®¾å¤‡: Bus 001 Device 004: ID 152d:0562 JMicron...
[INFO] æ­¥éª¤ 2/5: æŸ¥æ‰¾ç¡¬ç›˜è®¾å¤‡...
[SUCCESS] æ‰¾åˆ°ç¡¬ç›˜: /dev/sda
[INFO] æ­¥éª¤ 3/5: åˆ†æåˆ†åŒºç±»å‹...
[INFO] åˆ†åŒºç±»å‹: linux_raid_member
[WARNING] æ£€æµ‹åˆ°RAIDæˆå‘˜ï¼Œæ­£åœ¨ç»„è£…RAIDé˜µåˆ—...
[SUCCESS] RAIDè®¾å¤‡å·²æ¿€æ´»: /dev/md126
[INFO] RAIDè®¾å¤‡ç±»å‹: LVM2_member
[WARNING] æ£€æµ‹åˆ°LVM2æˆå‘˜ï¼Œæ­£åœ¨æ¿€æ´»é€»è¾‘å·...
[SUCCESS] é€»è¾‘å·å·²æ¿€æ´»: /dev/trim_8ed93b3b.../0
[INFO] æ­¥éª¤ 5/5: æŒ‚è½½è®¾å¤‡...
[SUCCESS] è®¾å¤‡å·²æŒ‚è½½åˆ°: /mnt/usb_backup

======================================
[SUCCESS] æŒ‚è½½å®Œæˆï¼
======================================

ç£ç›˜ä½¿ç”¨æƒ…å†µ:
  å®¹é‡: 238G
  å·²ç”¨: 136G
  å¯ç”¨: 101G
  ä½¿ç”¨ç‡: 58%
```

### 2ï¸âƒ£ è‡ªåŠ¨å¤‡ä»½

**è„šæœ¬**: `auto_backup_to_usb.sh`

**åŠŸèƒ½**:
- å¢é‡å¤‡ä»½ `/vol1` åˆ°ç§»åŠ¨ç¡¬ç›˜
- è‡ªåŠ¨æ’é™¤ä¸´æ—¶æ–‡ä»¶å’Œæ—¥å¿—
- ä¿ç•™æœ€è¿‘5ä¸ªå¤‡ä»½
- ç”Ÿæˆå¤‡ä»½å…ƒæ•°æ®

**æ’é™¤çš„ç›®å½•**:
- `lost+found`
- `@apptemp/*`
- `tmp/*`
- `*.log`

**å¤‡ä»½ä½ç½®**: `/mnt/usb_backup/fnos_backups/backup_YYYYMMDD_HHMMSS/`

**ç¤ºä¾‹è¾“å‡º**:
```
==========================================
  é£ç‰›OS è‡ªåŠ¨å¤‡ä»½å·¥å…·
==========================================

[INFO] æ­¥éª¤ 1/5: æ£€æŸ¥ç§»åŠ¨ç¡¬ç›˜æŒ‚è½½çŠ¶æ€...
[SUCCESS] ç§»åŠ¨ç¡¬ç›˜å·²æŒ‚è½½
[INFO] æ­¥éª¤ 2/5: åˆ›å»ºå¤‡ä»½ç›®å½•...
[SUCCESS] å¤‡ä»½ç›®å½•: /mnt/usb_backup/fnos_backups/backup_20251030_201500
[INFO] æ­¥éª¤ 3/5: æ£€æŸ¥ç£ç›˜ç©ºé—´...
[INFO] æºç›®å½•å¤§å°: 45.23GB
[INFO] å¯ç”¨ç©ºé—´: 101.50GB
[SUCCESS] ç©ºé—´æ£€æŸ¥é€šè¿‡
[INFO] æ­¥éª¤ 4/5: å¼€å§‹å¤‡ä»½...
[INFO] å¤‡ä»½æ–¹å¼: rsyncå¢é‡å¤‡ä»½
[INFO] è¿™å¯èƒ½éœ€è¦è¾ƒé•¿æ—¶é—´ï¼Œè¯·è€å¿ƒç­‰å¾…...

sending incremental file list
...

[SUCCESS] å¤‡ä»½å®Œæˆï¼ç”¨æ—¶: 15åˆ†32ç§’
```

### 3ï¸âƒ£ å®‰å…¨å¸è½½

**è„šæœ¬**: `umount_usb_backup.sh`

**åŠŸèƒ½**:
- æ£€æŸ¥å¹¶å…³é—­æ­£åœ¨ä½¿ç”¨çš„è¿›ç¨‹
- å¸è½½æ–‡ä»¶ç³»ç»Ÿ
- åœç”¨LVMé€»è¾‘å·
- åœç”¨RAIDé˜µåˆ—

**ç¤ºä¾‹è¾“å‡º**:
```
======================================
  ç§»åŠ¨ç¡¬ç›˜å®‰å…¨å¸è½½å·¥å…·
======================================

[INFO] æ­¥éª¤ 1/4: æ£€æŸ¥æŒ‚è½½çŠ¶æ€...
[SUCCESS] æ£€æµ‹åˆ°å·²æŒ‚è½½è®¾å¤‡
[INFO] æ­¥éª¤ 2/4: å¸è½½æ–‡ä»¶ç³»ç»Ÿ...
[SUCCESS] æ–‡ä»¶ç³»ç»Ÿå·²å¸è½½
[INFO] æ­¥éª¤ 3/4: åœç”¨LVMé€»è¾‘å·...
[SUCCESS] LVMå·ç»„å·²åœç”¨: trim_8ed93b3b_e241_4932_bad8_633fa001c81a
[INFO] æ­¥éª¤ 4/4: åœç”¨RAIDé˜µåˆ—...
[SUCCESS] RAIDé˜µåˆ—å·²åœç”¨: /dev/md126

======================================
[SUCCESS] å®‰å…¨å¸è½½å®Œæˆï¼
======================================

[SUCCESS] ç°åœ¨å¯ä»¥å®‰å…¨åœ°æ‹”å‡ºUSBè®¾å¤‡äº†
```

### 4ï¸âƒ£ æ¢å¤å¤‡ä»½

åœ¨ `usb-backup` èœå•ä¸­é€‰æ‹© `5) æ¢å¤å¤‡ä»½`ï¼š

1. åˆ—å‡ºæ‰€æœ‰å¯ç”¨å¤‡ä»½
2. æ˜¾ç¤ºæ¯ä¸ªå¤‡ä»½çš„è¯¦ç»†ä¿¡æ¯
3. é€‰æ‹©è¦æ¢å¤çš„å¤‡ä»½
4. ç¡®è®¤åæ‰§è¡Œæ¢å¤

**âš ï¸ è­¦å‘Š**: æ¢å¤æ“ä½œä¼šè¦†ç›–å½“å‰æ•°æ®ï¼Œè¯·è°¨æ…æ“ä½œï¼

---

## ğŸ› ï¸ æ•…éšœæ’é™¤

### é—®é¢˜1: ç§»åŠ¨ç¡¬ç›˜æ— æ³•è¯†åˆ«

**ç—‡çŠ¶**: æ‰§è¡Œ `lsusb` èƒ½çœ‹åˆ°è®¾å¤‡ï¼Œä½† `ls /dev/sd*` æ²¡æœ‰è®¾å¤‡

**åŸå› **: SATAç¡¬ç›˜ä¸ç¡¬ç›˜ç›’è¿æ¥ä¸è‰¯

**è§£å†³æ–¹æ¡ˆ**:
1. é‡æ–°æ’æ‹”USBçº¿
2. æ£€æŸ¥ç¡¬ç›˜ç›’ç”µæº
3. æ£€æŸ¥ç¡¬ç›˜ç›’å†…SATAè¿æ¥

### é—®é¢˜2: æŒ‚è½½å¤±è´¥ "unknown filesystem"

**ç—‡çŠ¶**: `mount: unknown filesystem type 'linux_raid_member'`

**è§£å†³æ–¹æ¡ˆ**: ä½¿ç”¨ `mount_usb_backup.sh`ï¼Œå®ƒä¼šè‡ªåŠ¨å¤„ç†RAIDå’ŒLVM

### é—®é¢˜3: ç©ºé—´ä¸è¶³

**ç—‡çŠ¶**: å¤‡ä»½æ—¶æç¤ºç©ºé—´ä¸è¶³

**è§£å†³æ–¹æ¡ˆ**:
```bash
# æŸ¥çœ‹æ—§å¤‡ä»½
ls -lth /mnt/usb_backup/fnos_backups/

# æ‰‹åŠ¨åˆ é™¤æ—§å¤‡ä»½
rm -rf /mnt/usb_backup/fnos_backups/backup_YYYYMMDD_HHMMSS
```

### é—®é¢˜4: å¸è½½æ—¶æç¤ºè®¾å¤‡å¿™

**ç—‡çŠ¶**: `umount: target is busy`

**è§£å†³æ–¹æ¡ˆ**: 
```bash
# æŸ¥æ‰¾å ç”¨è¿›ç¨‹
lsof +D /mnt/usb_backup

# å¼ºåˆ¶å¸è½½
umount -l /mnt/usb_backup
```

---

## ğŸ“Š æŠ€æœ¯ç»†èŠ‚

### ç¡¬ç›˜ç»“æ„

ä½ çš„ç§»åŠ¨ç¡¬ç›˜é‡‡ç”¨ä»¥ä¸‹ç»“æ„ï¼š

```
/dev/sda (ç‰©ç†è®¾å¤‡)
â””â”€â”€ /dev/sda1 (åˆ†åŒº)
    â””â”€â”€ /dev/md126 (RAID linearé˜µåˆ—)
        â””â”€â”€ /dev/trim_8ed93b3b_e241_4932_bad8_633fa001c81a/0 (LVMé€»è¾‘å·)
            â””â”€â”€ btrfsæ–‡ä»¶ç³»ç»Ÿ
```

### æŒ‚è½½æµç¨‹

1. **USBè¯†åˆ«**: JMicron JMS567 SATAæ¡¥æ¥èŠ¯ç‰‡
2. **SCSIæšä¸¾**: åˆ›å»º `/dev/sda`
3. **RAIDç»„è£…**: `mdadm --assemble` â†’ `/dev/md126`
4. **LVMæ¿€æ´»**: `vgchange -ay` â†’ `/dev/mapper/trim_*/0`
5. **æ–‡ä»¶ç³»ç»ŸæŒ‚è½½**: `mount` â†’ `/mnt/usb_backup`

---

## ğŸ”§ é«˜çº§é…ç½®

### ä¿®æ”¹å¤‡ä»½æº

ç¼–è¾‘ `auto_backup_to_usb.sh`:

```bash
SOURCE_DIR="/vol1"  # æ”¹ä¸ºä½ è¦å¤‡ä»½çš„ç›®å½•
```

### ä¿®æ”¹å¤‡ä»½ä¿ç•™æ•°é‡

ç¼–è¾‘ `auto_backup_to_usb.sh`:

```bash
# æ¸…ç†æ—§å¤‡ä»½ï¼ˆä¿ç•™æœ€è¿‘5ä¸ªï¼‰
ls -t | grep "^backup_" | tail -n +6 | xargs -r rm -rf
                                    # â†‘ æ”¹è¿™é‡Œçš„æ•°å­—
```

### æ·»åŠ æ’é™¤è§„åˆ™

ç¼–è¾‘ `auto_backup_to_usb.sh` ä¸­çš„ `rsync` å‘½ä»¤ï¼š

```bash
rsync -avh --progress \
    --exclude="lost+found" \
    --exclude="@apptemp/*" \
    --exclude="æ–°çš„æ’é™¤è§„åˆ™" \
    "$SOURCE_DIR/" "$BACKUP_DIR/"
```

---

## ğŸ“… å®šæ—¶å¤‡ä»½ï¼ˆå¯é€‰ï¼‰

### åˆ›å»ºcronä»»åŠ¡

```bash
# ç¼–è¾‘crontab
crontab -e

# æ¯å¤©å‡Œæ™¨2ç‚¹è‡ªåŠ¨å¤‡ä»½
0 2 * * * /usr/local/bin/mount_usb_backup.sh && /usr/local/bin/auto_backup_to_usb.sh && /usr/local/bin/umount_usb_backup.sh
```

### ä½¿ç”¨systemd timerï¼ˆæ¨èï¼‰

åˆ›å»º `/etc/systemd/system/usb-backup.service`:

```ini
[Unit]
Description=USB Backup Service
After=multi-user.target

[Service]
Type=oneshot
ExecStart=/usr/local/bin/mount_usb_backup.sh
ExecStart=/usr/local/bin/auto_backup_to_usb.sh
ExecStop=/usr/local/bin/umount_usb_backup.sh
```

åˆ›å»º `/etc/systemd/system/usb-backup.timer`:

```ini
[Unit]
Description=USB Backup Timer

[Timer]
OnCalendar=daily
Persistent=true

[Install]
WantedBy=timers.target
```

å¯ç”¨å®šæ—¶å™¨ï¼š

```bash
systemctl daemon-reload
systemctl enable usb-backup.timer
systemctl start usb-backup.timer
```

---

## ğŸ“ è„šæœ¬æ–‡ä»¶æ¸…å•

| æ–‡ä»¶å | åŠŸèƒ½ | ä½ç½® |
|--------|------|------|
| `mount_usb_backup.sh` | æŒ‚è½½ç§»åŠ¨ç¡¬ç›˜ | `/usr/local/bin/` |
| `umount_usb_backup.sh` | å®‰å…¨å¸è½½ | `/usr/local/bin/` |
| `auto_backup_to_usb.sh` | è‡ªåŠ¨å¤‡ä»½ | `/usr/local/bin/` |
| `usb_backup_manager.sh` | å›¾å½¢åŒ–ç®¡ç†å™¨ | `/usr/local/bin/` |
| `install_usb_backup.sh` | å®‰è£…è„šæœ¬ | `/tmp/` |
| `usb-backup` | å¿«æ·å‘½ä»¤ï¼ˆè½¯é“¾æ¥ï¼‰ | `/usr/local/bin/` |

---

## â“ å¸¸è§é—®é¢˜

**Q: ç¬¬ä¸€æ¬¡ä½¿ç”¨éœ€è¦æ ¼å¼åŒ–ç§»åŠ¨ç¡¬ç›˜å—ï¼Ÿ**  
A: ä¸éœ€è¦ã€‚ä½ çš„ç§»åŠ¨ç¡¬ç›˜å·²ç»åŒ…å«å®Œæ•´çš„æ•°æ®ç»“æ„ï¼ˆRAID+LVM+btrfsï¼‰ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨ã€‚

**Q: å¤‡ä»½ä¼šè¦†ç›–ç§»åŠ¨ç¡¬ç›˜åŸæœ‰æ•°æ®å—ï¼Ÿ**  
A: ä¸ä¼šã€‚å¤‡ä»½ä¼šåˆ›å»ºåœ¨ `/mnt/usb_backup/fnos_backups/` ç›®å½•ä¸‹ï¼Œä¸å½±å“åŸæœ‰çš„ç”¨æˆ·æ•°æ®ï¼ˆå¦‚ `/mnt/usb_backup/1000/ç”»ç”»`ï¼‰ã€‚

**Q: å¯ä»¥åŒæ—¶è¿æ¥å¤šä¸ªç§»åŠ¨ç¡¬ç›˜å—ï¼Ÿ**  
A: å½“å‰è„šæœ¬è®¾è®¡ä¸ºå•ä¸ªç§»åŠ¨ç¡¬ç›˜ã€‚å¦‚éœ€æ”¯æŒå¤šä¸ªï¼Œéœ€è¦ä¿®æ”¹æŒ‚è½½ç‚¹é…ç½®ã€‚

**Q: å¢é‡å¤‡ä»½æ˜¯å¦‚ä½•å·¥ä½œçš„ï¼Ÿ**  
A: ä½¿ç”¨ `rsync`ï¼Œåªä¼ è¾“å˜åŒ–çš„æ–‡ä»¶ï¼Œå¤§å¹…å‡å°‘å¤‡ä»½æ—¶é—´å’Œç©ºé—´å ç”¨ã€‚

**Q: å¦‚ä½•æŸ¥çœ‹å¤‡ä»½è¿›åº¦ï¼Ÿ**  
A: ä½¿ç”¨ `usb-backup` èœå•å¯åŠ¨å¤‡ä»½ï¼Œä¼šå®æ—¶æ˜¾ç¤º `rsync` è¿›åº¦ã€‚

---

## ğŸ‰ æ€»ç»“

ç°åœ¨ä½ æ‹¥æœ‰äº†ä¸€å¥—å®Œæ•´çš„USBå¤‡ä»½è§£å†³æ–¹æ¡ˆï¼š

âœ… **å·²å®Œæˆ**:
- ç§»åŠ¨ç¡¬ç›˜æˆåŠŸæŒ‚è½½ï¼ˆ238GBï¼Œå·²ç”¨136GBï¼Œå¯ç”¨101GBï¼‰
- è‡ªåŠ¨è¯†åˆ«RAID+LVMç»“æ„
- å¤‡ä»½è„šæœ¬å·²éƒ¨ç½²
- å›¾å½¢åŒ–ç®¡ç†å·¥å…·å¯ç”¨

ğŸš€ **ç«‹å³ä½¿ç”¨**:
```bash
ssh root@192.168.31.104
usb-backup
```

---

*ç”Ÿæˆæ—¶é—´: 2025å¹´10æœˆ30æ—¥*  
*ç›®æ ‡ç³»ç»Ÿ: é£ç‰›OS*  
*ç§»åŠ¨ç¡¬ç›˜: EAGET 238GB (RAID + LVM + btrfs)*

